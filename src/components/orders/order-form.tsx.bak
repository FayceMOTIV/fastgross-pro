"use client";

import { useState } from "react";
import { useForm, useFieldArray } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Trash2, Search } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input, Textarea, Label } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { formatCurrency } from "@/lib/utils";
import type { Client, Product, Order } from "@/types";

const orderItemSchema = z.object({
  productId: z.string(),
  productRef: z.string(),
  productName: z.string(),
  quantity: z.number().min(1, "Quantité minimum: 1"),
  unitPrice: z.number(),
  discount: z.number().default(0),
  total: z.number(),
});

const orderSchema = z.object({
  clientId: z.string().min(1, "Veuillez sélectionner un client"),
  items: z.array(orderItemSchema).min(1, "Ajoutez au moins un produit"),
  deliveryDate: z.string().min(1, "Date de livraison requise"),
  deliverySlot: z.string().optional(),
  notes: z.string().optional(),
});

type OrderFormData = z.infer<typeof orderSchema>;

interface OrderFormProps {
  order?: Order;
  clients: Client[];
  products: Product[];
  onSubmit: (data: OrderFormData) => void;
  onCancel: () => void;
  isLoading?: boolean;
}

export function OrderForm({ order, clients, products, onSubmit, onCancel, isLoading }: OrderFormProps) {
  const [_selectedClient, setSelectedClient] = useState<Client | null>(
    order ? clients.find((c) => c.id === order.clientId) || null : null
  );
  const [productSearch, setProductSearch] = useState("");

  const {
    register,
    control,
    handleSubmit,
    watch,
    setValue,
    formState: { errors },
  } = useForm<OrderFormData>({
    resolver: zodResolver(orderSchema),
    defaultValues: order
      ? {
          clientId: order.clientId,
          items: order.items,
          deliveryDate: new Date(order.deliveryDate).toISOString().split("T")[0],
          deliverySlot: order.deliverySlot || "",
          notes: order.notes || "",
        }
      : {
          clientId: "",
          items: [],
          deliveryDate: "",
          deliverySlot: "",
          notes: "",
        },
  });

  const { fields, append, remove } = useFieldArray({
    control,
    name: "items",
  });

  const items = watch("items");

  const subtotal = items.reduce((sum, item) => sum + item.total, 0);
  const totalDiscount = items.reduce((sum, item) => sum + item.discount, 0);
  const tax = subtotal * 0.2;
  const total = subtotal + tax;

  const filteredProducts = products.filter(
    (p) =>
      p.name.toLowerCase().includes(productSearch.toLowerCase()) ||
      p.ref.toLowerCase().includes(productSearch.toLowerCase())
  );

  const addProduct = (product: Product) => {
    const existingIndex = fields.findIndex((f) => f.productId === product.id);
    if (existingIndex >= 0) {
      const currentQty = items[existingIndex].quantity;
      setValue(`items.${existingIndex}.quantity`, currentQty + 1);
      setValue(
        `items.${existingIndex}.total`,
        (currentQty + 1) * items[existingIndex].unitPrice
      );
    } else {
      append({
        productId: product.id,
        productRef: product.ref,
        productName: product.name,
        quantity: 1,
        unitPrice: product.basePrice,
        discount: 0,
        total: product.basePrice,
      });
    }
    setProductSearch("");
  };

  const updateQuantity = (index: number, quantity: number) => {
    if (quantity < 1) return;
    setValue(`items.${index}.quantity`, quantity);
    setValue(`items.${index}.total`, quantity * items[index].unitPrice);
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      {/* Client Selection */}
      <div className="space-y-2">
        <Label htmlFor="clientId" required>Client</Label>
        <select
          id="clientId"
          {...register("clientId")}
          onChange={(e) => {
            const client = clients.find((c) => c.id === e.target.value);
            setSelectedClient(client || null);
          }}
          className="flex h-10 w-full rounded-lg border border-border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
        >
          <option value="">Sélectionner un client</option>
          {clients.map((client) => (
            <option key={client.id} value={client.id}>
              {client.name} - {client.address.city}
            </option>
          ))}
        </select>
        {errors.clientId && (
          <p className="text-sm text-danger-500">{errors.clientId.message}</p>
        )}
      </div>

      {/* Products */}
      <Card>
        <CardHeader>
          <CardTitle>Produits</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* Search Products */}
          <div className="relative">
            <Input
              type="search"
              placeholder="Rechercher un produit..."
              value={productSearch}
              onChange={(e) => setProductSearch(e.target.value)}
              icon={<Search className="h-4 w-4" />}
            />
            {productSearch && (
              <div className="absolute top-full left-0 right-0 z-10 mt-1 max-h-48 overflow-auto rounded-lg border border-border bg-card shadow-lg">
                {filteredProducts.length === 0 ? (
                  <div className="p-3 text-sm text-muted-foreground">
                    Aucun produit trouvé
                  </div>
                ) : (
                  filteredProducts.slice(0, 10).map((product) => (
                    <button
                      key={product.id}
                      type="button"
                      onClick={() => addProduct(product)}
                      className="w-full px-3 py-2 text-left hover:bg-muted flex items-center justify-between"
                    >
                      <div>
                        <p className="font-medium">{product.name}</p>
                        <p className="text-xs text-muted-foreground">
                          Réf: {product.ref}
                        </p>
                      </div>
                      <span className="font-medium">
                        {formatCurrency(product.basePrice)}
                      </span>
                    </button>
                  ))
                )}
              </div>
            )}
          </div>

          {/* Items List */}
          {fields.length === 0 ? (
            <div className="text-center py-8 text-muted-foreground">
              Aucun produit ajouté. Utilisez la recherche ci-dessus.
            </div>
          ) : (
            <div className="space-y-3">
              {fields.map((field, index) => (
                <div
                  key={field.id}
                  className="flex items-center gap-4 p-3 rounded-lg bg-muted/50"
                >
                  <div className="flex-1 min-w-0">
                    <p className="font-medium truncate">{field.productName}</p>
                    <p className="text-xs text-muted-foreground">
                      {formatCurrency(items[index]?.unitPrice || 0)} / unité
                    </p>
                  </div>
                  <div className="flex items-center gap-2">
                    <Button
                      type="button"
                      variant="outline"
                      size="icon-sm"
                      onClick={() => updateQuantity(index, (items[index]?.quantity || 1) - 1)}
                    >
                      -
                    </Button>
                    <span className="w-8 text-center font-medium">
                      {items[index]?.quantity || 1}
                    </span>
                    <Button
                      type="button"
                      variant="outline"
                      size="icon-sm"
                      onClick={() => updateQuantity(index, (items[index]?.quantity || 1) + 1)}
                    >
                      +
                    </Button>
                  </div>
                  <span className="font-medium w-24 text-right">
                    {formatCurrency(items[index]?.total || 0)}
                  </span>
                  <Button
                    type="button"
                    variant="ghost"
                    size="icon-sm"
                    onClick={() => remove(index)}
                    className="text-red-500 hover:text-red-600"
                  >
                    <Trash2 className="h-4 w-4" />
                  </Button>
                </div>
              ))}
            </div>
          )}
          {errors.items && (
            <p className="text-sm text-danger-500">{errors.items.message}</p>
          )}

          {/* Totals */}
          {fields.length > 0 && (
            <div className="pt-4 border-t border-border space-y-2">
              <div className="flex justify-between text-sm">
                <span className="text-muted-foreground">Sous-total</span>
                <span>{formatCurrency(subtotal)}</span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-muted-foreground">TVA (20%)</span>
                <span>{formatCurrency(tax)}</span>
              </div>
              {totalDiscount > 0 && (
                <div className="flex justify-between text-sm text-green-600">
                  <span>Remise</span>
                  <span>-{formatCurrency(totalDiscount)}</span>
                </div>
              )}
              <div className="flex justify-between text-lg font-bold pt-2 border-t">
                <span>Total TTC</span>
                <span className="text-primary-600">{formatCurrency(total)}</span>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Delivery Info */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="space-y-2">
          <Label htmlFor="deliveryDate" required>Date de livraison</Label>
          <Input
            id="deliveryDate"
            type="date"
            {...register("deliveryDate")}
            error={!!errors.deliveryDate}
            min={new Date().toISOString().split("T")[0]}
          />
          {errors.deliveryDate && (
            <p className="text-sm text-danger-500">{errors.deliveryDate.message}</p>
          )}
        </div>

        <div className="space-y-2">
          <Label htmlFor="deliverySlot">Créneau de livraison</Label>
          <select
            id="deliverySlot"
            {...register("deliverySlot")}
            className="flex h-10 w-full rounded-lg border border-border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
          >
            <option value="">Flexible</option>
            <option value="08:00-10:00">08:00 - 10:00</option>
            <option value="10:00-12:00">10:00 - 12:00</option>
            <option value="14:00-16:00">14:00 - 16:00</option>
            <option value="16:00-18:00">16:00 - 18:00</option>
          </select>
        </div>
      </div>

      {/* Notes */}
      <div className="space-y-2">
        <Label htmlFor="notes">Notes</Label>
        <Textarea
          id="notes"
          {...register("notes")}
          placeholder="Instructions spéciales pour la livraison..."
          rows={3}
        />
      </div>

      {/* Actions */}
      <div className="flex justify-end gap-3 pt-4 border-t border-border">
        <Button type="button" variant="outline" onClick={onCancel}>
          Annuler
        </Button>
        <Button type="submit" loading={isLoading}>
          {order ? "Mettre à jour" : "Créer la commande"}
        </Button>
      </div>
    </form>
  );
}
