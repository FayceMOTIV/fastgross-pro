/**
 * Script d'import des donnees de demo dans Firebase
 *
 * Usage:
 *   npx ts-node scripts/seed-firebase.ts
 *
 * Prerequis:
 *   - Variables d'environnement Firebase configurees
 *   - Compte admin Firebase
 */

import { initializeApp, cert, ServiceAccount } from "firebase-admin/app";
import { getFirestore } from "firebase-admin/firestore";
import {
  COMPANY,
  USERS,
  CLIENTS,
  PRODUCTS,
  ORDERS,
  INVOICES,
  ALERTS,
  DRIVER_LOCATIONS,
  DASHBOARD_STATS,
} from "../src/lib/seed-data";

// Configuration Firebase Admin
// Utiliser soit les variables d'environnement, soit un fichier de service account
const serviceAccount: ServiceAccount = {
  projectId: process.env.FIREBASE_PROJECT_ID || "fastgross-pro",
  privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, "\n"),
  clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
};

// Initialiser Firebase Admin
initializeApp({
  credential: cert(serviceAccount),
});

const db = getFirestore();

// Couleurs pour le terminal
const colors = {
  reset: "\x1b[0m",
  green: "\x1b[32m",
  yellow: "\x1b[33m",
  blue: "\x1b[34m",
  red: "\x1b[31m",
};

function log(message: string, color: keyof typeof colors = "reset") {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

async function seedCollection(
  collectionName: string,
  data: Record<string, unknown>[],
  idField: string = "id"
) {
  log(`\nüì¶ Import de ${collectionName}...`, "blue");

  const batch = db.batch();
  let count = 0;

  for (const item of data) {
    const docId = (item as Record<string, string>)[idField];
    const ref = db.collection(collectionName).doc(docId);
    batch.set(ref, {
      ...item,
      _importedAt: new Date().toISOString(),
    });
    count++;
  }

  await batch.commit();
  log(`   ‚úÖ ${count} documents importes`, "green");
}

async function seedCompany() {
  log("\nüè¢ Import des informations entreprise...", "blue");

  await db.collection("settings").doc("company").set({
    ...COMPANY,
    _importedAt: new Date().toISOString(),
  });

  log("   ‚úÖ Configuration entreprise importee", "green");
}

async function seedDashboardStats() {
  log("\nüìä Import des statistiques...", "blue");

  await db.collection("stats").doc("dashboard").set({
    ...DASHBOARD_STATS,
    _importedAt: new Date().toISOString(),
  });

  log("   ‚úÖ Statistiques importees", "green");
}

async function clearCollection(collectionName: string) {
  log(`   üóëÔ∏è  Suppression de ${collectionName}...`, "yellow");

  const snapshot = await db.collection(collectionName).get();
  const batch = db.batch();

  snapshot.docs.forEach((doc) => {
    batch.delete(doc.ref);
  });

  if (snapshot.docs.length > 0) {
    await batch.commit();
    log(`   ‚úÖ ${snapshot.docs.length} documents supprimes`, "green");
  }
}

async function clearAllData() {
  log("\n‚ö†Ô∏è  Nettoyage des donnees existantes...", "yellow");

  const collections = [
    "users",
    "clients",
    "products",
    "orders",
    "invoices",
    "alerts",
    "driverLocations",
    "settings",
    "stats",
  ];

  for (const collection of collections) {
    await clearCollection(collection);
  }

  log("‚úÖ Nettoyage termine", "green");
}

async function main() {
  console.log("\n" + "=".repeat(60));
  log("üöÄ FASTGROSS PRO - Import des donnees de demonstration", "blue");
  console.log("=".repeat(60));

  const args = process.argv.slice(2);
  const shouldClear = args.includes("--clear") || args.includes("-c");

  if (shouldClear) {
    await clearAllData();
  }

  try {
    // Import des donnees
    await seedCompany();
    await seedCollection("users", USERS);
    await seedCollection("clients", CLIENTS);
    await seedCollection("products", PRODUCTS);
    await seedCollection("orders", ORDERS);
    await seedCollection("invoices", INVOICES);
    await seedCollection("alerts", ALERTS);
    await seedCollection("driverLocations", DRIVER_LOCATIONS);
    await seedDashboardStats();

    console.log("\n" + "=".repeat(60));
    log("‚úÖ IMPORT TERMINE AVEC SUCCES!", "green");
    console.log("=".repeat(60));

    log("\nüìã Resume de l'import:", "blue");
    log(`   ‚Ä¢ Entreprise: ${COMPANY.name}`, "reset");
    log(`   ‚Ä¢ Utilisateurs: ${USERS.length}`, "reset");
    log(`   ‚Ä¢ Clients: ${CLIENTS.length}`, "reset");
    log(`   ‚Ä¢ Produits: ${PRODUCTS.length}`, "reset");
    log(`   ‚Ä¢ Commandes: ${ORDERS.length}`, "reset");
    log(`   ‚Ä¢ Factures: ${INVOICES.length}`, "reset");
    log(`   ‚Ä¢ Alertes: ${ALERTS.length}`, "reset");
    log(`   ‚Ä¢ Positions livreurs: ${DRIVER_LOCATIONS.length}`, "reset");

    log("\nüí° Prochaines etapes:", "yellow");
    log("   1. Verifier les donnees dans la console Firebase", "reset");
    log("   2. Tester l'application avec les comptes de demo", "reset");
    log("   3. Comptes disponibles:", "reset");
    log("      - Admin: admin@medifresh.fr", "reset");
    log("      - Manager: manager@medifresh.fr", "reset");
    log("      - Commercial: karim@medifresh.fr", "reset");
    log("      - Livreur: ahmed@medifresh.fr", "reset");

  } catch (error) {
    log("\n‚ùå ERREUR lors de l'import:", "red");
    console.error(error);
    process.exit(1);
  }
}

// Execution
main()
  .then(() => {
    log("\nüëã Script termine.\n", "blue");
    process.exit(0);
  })
  .catch((error) => {
    log("\n‚ùå Erreur fatale:", "red");
    console.error(error);
    process.exit(1);
  });
